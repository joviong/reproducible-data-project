library(tidyverse)
library(zoo)

# get a vector of the file names in the data directory
file_names <- list.files("data")

# initialise an empty list to store the processed data in later on
data_list <- list()

## start of loop
for (i in seq_along(file_names)) {   # loop through the file_names
  
  # 1. read in the ith data file and store it in object 'dat'
  dat <- read_csv(paste("data/", file_names[i], sep = ""))
  
  ## 2. clean up the split variable by removing the 'Split #'
  ## and keeping just the number
  dat$split <- dat$split %>%
    # search for pattern "Split #"
    str_replace(pattern = "Split #",   
                # replace with "", i.e. nothing
                replacement = "") %>%   
    # convert to numeric var
    as.numeric() 
  
  ## 3. Arrange the data by athlete_no, start_time and split number
  dat <- dat %>%
    arrange(athlete_no, start_time, split)
  
  ## 4. Calculate the rolling sums
  dat <- dat %>%
    # need to group by athlete so the rolling sum restarts for each athlete
    group_by(athlete_no) %>%
    # create new variables for the rolling sums
    mutate(
      # calculate rolling sums for distance
      distance_1min = rollapplyr(distance, width = 2, FUN = sum, partial = TRUE),
      distance_2min = rollapplyr(distance, width = 4, FUN = sum, partial = TRUE),
      distance_5min = rollapplyr(distance, width = 10, FUN = sum, partial = TRUE),
      # calculate rolling sums for high-speed distance     
      hsd_1min = rollapplyr(high_gt5ms, width = 2, FUN = sum, partial = TRUE),
      hsd_2min = rollapplyr(high_gt5ms, width = 4, FUN = sum, partial = TRUE),
      hsd_5min = rollapplyr(high_gt5ms, width = 10, FUN = sum, partial = TRUE)
    ) %>%
    #ungroup the dataframe so further functions aren't performed by athlete
    ungroup()
  
  ## 5. store the data in the ith element of data_list
  data_list[[i]] <- dat
  
}
## end of loop